# Copyright (c) 2007 Alexander Færøy <ahf@exherbo.org>
# Copyright (c) 2008, 2009, 2010 Ingmar Vanhassel <ingmar@exherbo.org>
# Distributed under the terms of the GNU General Public License v2

require bash-completion zsh-completion elisp-optional [ source_directory=contrib ] distutils

SUMMARY="A fast, lightweight, distributed source control management system"
HOMEPAGE="http://mercurial.selenic.com/"
DOWNLOADS="http://www.selenic.com/${PN}/release/${PNV}.tar.gz"

UPSTREAM_RELEASE_NOTES="
    http://mercurial.selenic.com/wiki/WhatsNew [[ lang = en ]]
    http://mercurial.selenic.com/wiki/UpgradeNotes [[
        lang = en
        description = [ Important notes on upgrading from previous versions ]
    ]]
    http://mercurial.selenic.com/wiki/HgkExtension [[
        lang = en
        description = [ Setting up Hgk ]
    ]]
"

LICENCES="|| ( GPL-3 GPL-2 )"
SLOT="0"
PLATFORMS="~amd64 ~x86"
MYOPTIONS="tk [[ description = [ Install hgk, a port to mercurial of git's gitk repository viewer ] ]]"

DEPENDENCIES="
    build+run:
        dev-lang/python:=[>=2.4]
        tk? (
            dev-lang/tcl[>=8.4]
            dev-lang/tk[>=8.4]
        )
"

REMOTE_IDS="pypi:${PN}"

src_compile() {
    distutils_src_compile
    elisp-optional_src_compile
}

src_test() {
    sydboxcmd sandunbox/net
    edo cd tests
    # At least in mercurial-1.5.4, the upstream tests break if
    # we run them in more than one job.
    # edo ${PYTHON} ./run-tests.py -j${EXJOBS:-1} --verbose
    edo ${PYTHON} ./run-tests.py -j1 --verbose
    sydboxcmd sandbox/net
}

src_install() {
    distutils_src_install
    dobashcompletion contrib/bash_completion
    dozshcompletion contrib/zsh_completion _hg
    elisp-optional_src_install
    doman doc/hg*.?
    dodoc doc/{hg.1,hgignore.5,hgrc.5}.{html,txt} contrib/sample.hgrc

    if option tk ; then
        dobin contrib/hgk
    fi
}

