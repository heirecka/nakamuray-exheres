# Copyright 2011 NAKAMURA Yoshitaka
# Distributed under the terms of the GNU General Public License v2

require multilib flag-o-matic scons

SUMMARY="Google's open source JavaScript engine"
HOMEPAGE="http://code.google.com/p/v8"
DOWNLOADS="mirror://gentoo/${PNV}.tar.gz"

LICENCES="BSD"
SLOT="0"
PLATFORMS="~amd64"
MYOPTIONS="
    readline
    platform: amd64
"

DEPENDENCIES="
    build:
    build+run:
        readline? ( sys-libs/readline[>=6.1] )
"

BUGS_TO=""

DEFAULT_SRC_PREPARE_PATCHES=( -p0
    "${FILES}/${PN}-no-werror-r0.patch"
    "${FILES}/${PN}-no-O3-r0.patch"
    "${FILES}/${PN}-gentoo-bug-349794-r0.patch"
    "${FILES}/${PN}-upstream-bug-1016-r0.patch"
)

SCONS_SRC_CONFIGURE_PARAMS=( library=shared soname=on importenv="LINKFLAGS" )
SCONS_SRC_COMPILE_PARAMS=( library=shared soname=on importenv="LINKFLAGS" )

pkg_setup() {
    # Make the build respect LDFLAGS.
    export LINKFLAGS="${LDFLAGS}"
}

src_configure() {
    # GCC issues multiple warnings about strict-aliasing issues in v8 code.
    append-flags -fno-strict-aliasing
}

src_compile() {
    if option platform:amd64; then
        SCONS_SRC_COMPILE_PARAMS+=( arch=x64 )
    #elif option platform:x86; then
    #    SCONS_SRC_COMPILE_PARAMS+=( arch=ia32 )
    fi

    if option readline; then
        SCONS_SRC_COMPILE_PARAMS+=( console=readline )
    fi

    SCONS_SRC_COMPILE_PARAMS+=( . )
    scons_src_compile
}

src_install() {
    insinto /usr
    doins -r include || die

    dobin d8 || die

    dolib libv8-${PV}.so || die
    dosym libv8-${PV}.so /usr/$(get_libdir)/libv8.so || die

    dodoc AUTHORS ChangeLog || die
}

#src_test() {
#    tools/test.py --no-build -p dots --shell d8 || die
#}

