# Copyright 2011 NAKAMURA Yoshitaka
# Distributed under the terms of the GNU General Public License v2

SUMMARY="fast, compliant alternative implementation of the Python language"
HOMEPAGE="http://pypy.org/"
DOWNLOADS="https://bitbucket.org/pypy/pypy/downloads/${PNV}-src.tar.bz2"
# XXX: they depend on old openssl so can't use in exherbo
#    bootstrap? (
#        platform:amd64? (
#            https://bitbucket.org/${PN}/${PN}/downloads/${PNV}-linux64.tar.bz2
#        )
#        platform:x86? (
#            https://bitbucket.org/${PN}/${PN}/downloads/${PNV}-linux.tar.bz2
#        )
#    )

LICENCES="MIT"
SLOT="0"
PLATFORMS="~amd64"
#MYOPTIONS="bootstrap platform: amd64 x86"
MYOPTIONS="expat ncurses ssl
    bootstrap [[ description = [ use CPython to build pypy ] ]]
"

DEPENDENCIES="
    build:
        dev-libs/libffi
        bootstrap? ( dev-lang/python:*[>=2.5&<3.0] )
        !bootstrap? ( dev-lang/pypy )
        expat? ( dev-libs/expat )
        ncurses? ( sys-libs/ncurses )
        ssl? ( dev-libs/openssl )
"

WORK="${WORKBASE}"/${PNV}-src

#BOOTSTRAP_ID_AMD64="43780-b590cf6de419"
#BOOTSTRAP_ID_X86=""

src_compile() {
    #if option bootstrap; then
    #    if option platform:amd64; then
    #        "${WORKBASE}"/${PN}-c-jit-${BOOTSTRAP_ID_AMD64}-linux64/bin/pypy
    #    elif option platform:x86; then
    #        "${WORKBASE}"/${PN}-c-jit-${BOOTSTRAP_ID_X86}-linux/bin/pypy
    #    else
    #        die "no bootstrap binary for youre platform"
    #    fi
    #else
    #    pypy=pypy
    #fi
    if option bootstrap; then
        pypy=python2
    else
        pypy=pypy
    fi

    local myopts=()

    if option expat; then
        myopts+=( --withmod-pyexpat )
    else
        myopts+=( --withoutmod-pyexpat )
    fi

    if option ncurses; then
        myopts+=( --withmod-_minimal_curses )
    else
        myopts+=( --withoutmod-_minimal_curses )
    fi

    if option ssl; then
        myopts+=( --withmod-_ssl )
    else
        myopts+=( --withoutmod-_ssl )
    fi

    edo cd pypy/goal
    edo "${pypy}" ../../rpython/bin/rpython -Ojit targetpypystandalone "${myopts[@]}"

    # generate cffi caches
    local cffi_modules=(_sqlite3 syslog)
    if option ncurses; then
        cffi_modules+=(_curses)
    fi
    for m in ${cffi_modules[@]}; do
        # XXX: unset CFLAGS to avoid `bad value` error
        edo env -u CFLAGS -u CXXFLAGS \
            PYTHONPATH="${WORK}/lib-python/2.7:${WORK}/lib_pypy" \
            ./pypy-c -m ${m}
    done
}

src_install() {
    prefix=/usr/${LIBDIR}/pypy

    exeinto "${prefix}"/bin
    doexe "${WORK}"/pypy/goal/pypy-c

    dodir "${prefix}"/lib-python/
    # to copy executable bit, use cp instead of doins
    edo cp -r "${WORK}"/lib-python/2.7 "${IMAGE}/${prefix}"/lib-python/
    edo cp -r "${WORK}"/lib_pypy "${WORK}"/include "${IMAGE}/${prefix}"

    keepdir "${prefix}"/site-packages

    dodir /usr/bin
    dosym "${prefix}"/bin/pypy-c /usr/bin/pypy

    # generate pyc and pyo
    for d in lib-python lib_pypy; do
        edo "${IMAGE}/${prefix}/bin/pypy-c" \
            -mcompileall -f -q -d "${prefix}/${d}" -x "/tests?/" \
            "${IMAGE}/${prefix}/${d}"
        edo "${IMAGE}/${prefix}/bin/pypy-c" -O \
            -mcompileall -f -q -d "${prefix}/${d}" -x "/tests?/" \
            "${IMAGE}/${prefix}/${d}"
    done

    emagicdocs
}

